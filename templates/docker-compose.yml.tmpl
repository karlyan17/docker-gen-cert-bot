version: '3.7'
services:
{{ range $tls, $containers := groupBy $ "Env.TLS"}}
    http-verification-{{ $tls }}:
        image: nginx
        volumes:
            - "well-known:/www/:ro"
        environment:
            - "VIRTUAL_HOST={{ range $container := $containers }}{{ $container.Env.VIRTUAL_HOST }},{{ end }}"
        networks:
            - haproxy-net
{{ end }}

networks:
    haproxy-net:
        external:
            name: haproxy

volumes:
    well-known:
